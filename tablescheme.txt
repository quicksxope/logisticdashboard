BEGIN;

-- optional schema
CREATE SCHEMA IF NOT EXISTS procwh;
SET search_path = procwh, public;

---------------------------------------------
-- MASTER TABLES
---------------------------------------------
CREATE TABLE IF NOT EXISTS m_employee (
    employee_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(200) NOT NULL
);

CREATE TABLE IF NOT EXISTS m_uom (
    uom_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);

CREATE TABLE IF NOT EXISTS m_location (
    location_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(200) NOT NULL
);

CREATE TABLE IF NOT EXISTS m_item (
    item_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(300) NOT NULL,
    base_uom_id VARCHAR(50) REFERENCES m_uom(uom_id) ON UPDATE CASCADE ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS m_vendor (
    vendor_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(300) NOT NULL
);

---------------------------------------------
-- PURCHASE REQUISITION (PR)
---------------------------------------------
CREATE TABLE IF NOT EXISTS t_pr_header (
    pr_id VARCHAR(50) PRIMARY KEY,
    employee_id VARCHAR(50) REFERENCES m_employee(employee_id) ON UPDATE CASCADE ON DELETE SET NULL,
    pr_date DATE NOT NULL DEFAULT CURRENT_DATE,
    status VARCHAR(32) NOT NULL DEFAULT 'OPEN',
    remarks TEXT,               -- tambahan: catatan PR di header
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_pr_header_pr_date ON t_pr_header(pr_date);
CREATE INDEX IF NOT EXISTS idx_pr_header_status ON t_pr_header(status);

CREATE TABLE IF NOT EXISTS t_pr_detail (
    pr_detail_id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    pr_id VARCHAR(50) NOT NULL REFERENCES t_pr_header(pr_id) ON DELETE CASCADE,
    item_id VARCHAR(50) REFERENCES m_item(item_id) ON UPDATE CASCADE,
    description TEXT,           -- tambahan: deskripsi item per PR
    qty_requested NUMERIC(18,4) NOT NULL CHECK (qty_requested >= 0),
    uom_id VARCHAR(50) REFERENCES m_uom(uom_id) ON UPDATE CASCADE ON DELETE SET NULL,
    unit_price NUMERIC(18,4),
    total_amount NUMERIC(20,4),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_pr_detail_pr_id ON t_pr_detail(pr_id);
CREATE INDEX IF NOT EXISTS idx_pr_detail_item_id ON t_pr_detail(item_id);

---------------------------------------------
-- PURCHASE ORDER (PO)
---------------------------------------------
CREATE TABLE IF NOT EXISTS t_po_header (
    po_id VARCHAR(50) PRIMARY KEY,
    vendor_id VARCHAR(50) REFERENCES m_vendor(vendor_id) ON UPDATE CASCADE ON DELETE SET NULL,
    pr_id VARCHAR(50) REFERENCES t_pr_header(pr_id) ON UPDATE CASCADE ON DELETE SET NULL,
    po_date DATE NOT NULL DEFAULT CURRENT_DATE,
    status VARCHAR(32) NOT NULL DEFAULT 'ISSUED',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_po_header_vendor ON t_po_header(vendor_id);
CREATE INDEX IF NOT EXISTS idx_po_header_pr_id ON t_po_header(pr_id);

CREATE TABLE IF NOT EXISTS t_po_detail (
    po_detail_id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    po_id VARCHAR(50) NOT NULL REFERENCES t_po_header(po_id) ON DELETE CASCADE,
    pr_detail_id BIGINT REFERENCES t_pr_detail(pr_detail_id) ON UPDATE CASCADE ON DELETE SET NULL,
    item_id VARCHAR(50) REFERENCES m_item(item_id) ON UPDATE CASCADE,
    qty_ordered NUMERIC(18,4) NOT NULL CHECK (qty_ordered >= 0),
    uom_id VARCHAR(50) REFERENCES m_uom(uom_id) ON UPDATE CASCADE ON DELETE SET NULL,
    unit_price NUMERIC(18,4),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_po_detail_po_id ON t_po_detail(po_id);
CREATE INDEX IF NOT EXISTS idx_po_detail_pr_detail_id ON t_po_detail(pr_detail_id);

---------------------------------------------
-- GOODS RECEIPT (GR)
---------------------------------------------
CREATE TABLE IF NOT EXISTS t_gr_header (
    gr_id VARCHAR(50) PRIMARY KEY,
    gr_date DATE NOT NULL DEFAULT CURRENT_DATE,
    po_id VARCHAR(50) REFERENCES t_po_header(po_id) ON UPDATE CASCADE ON DELETE SET NULL,
    receiving_employee_id VARCHAR(50) REFERENCES m_employee(employee_id) ON UPDATE CASCADE ON DELETE SET NULL,
    receiving_location_id VARCHAR(50) REFERENCES m_location(location_id) ON UPDATE CASCADE ON DELETE SET NULL,
    doc_ref VARCHAR(200),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_gr_header_po_id ON t_gr_header(po_id);

CREATE TABLE IF NOT EXISTS t_gr_detail (
    gr_detail_id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    gr_id VARCHAR(50) NOT NULL REFERENCES t_gr_header(gr_id) ON DELETE CASCADE,
    po_detail_id BIGINT REFERENCES t_po_detail(po_detail_id) ON UPDATE CASCADE ON DELETE SET NULL,
    item_id VARCHAR(50) REFERENCES m_item(item_id) ON UPDATE CASCADE,
    qty_received NUMERIC(18,4) NOT NULL CHECK (qty_received >= 0),
    uom_id VARCHAR(50) REFERENCES m_uom(uom_id) ON UPDATE CASCADE ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_gr_detail_gr_id ON t_gr_detail(gr_id);
CREATE INDEX IF NOT EXISTS idx_gr_detail_po_detail_id ON t_gr_detail(po_detail_id);

---------------------------------------------
-- STOCK TABLES
---------------------------------------------
CREATE TABLE IF NOT EXISTS t_stock_movement (
    movement_id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    movement_date TIMESTAMP WITH TIME ZONE DEFAULT now(),
    item_id VARCHAR(50) REFERENCES m_item(item_id) ON UPDATE CASCADE ON DELETE RESTRICT,
    location_id VARCHAR(50) REFERENCES m_location(location_id) ON UPDATE CASCADE ON DELETE RESTRICT,
    gr_id VARCHAR(50) REFERENCES t_gr_header(gr_id) ON UPDATE CASCADE ON DELETE SET NULL,
    employee_id VARCHAR(50) REFERENCES m_employee(employee_id) ON UPDATE CASCADE ON DELETE SET NULL,
    qty NUMERIC(18,4) NOT NULL,
    type VARCHAR(10) NOT NULL, -- GR / GI / ADJ
    reference TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_stock_movement_item_loc ON t_stock_movement(item_id, location_id);
CREATE INDEX IF NOT EXISTS idx_stock_movement_gr_id ON t_stock_movement(gr_id);

CREATE TABLE IF NOT EXISTS m_stock (
    stock_id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    item_id VARCHAR(50) NOT NULL REFERENCES m_item(item_id) ON UPDATE CASCADE ON DELETE RESTRICT,
    location_id VARCHAR(50) NOT NULL REFERENCES m_location(location_id) ON UPDATE CASCADE ON DELETE RESTRICT,
    current_qty NUMERIC(18,4) NOT NULL DEFAULT 0,
    last_updated TIMESTAMP WITH TIME ZONE DEFAULT now(),
    UNIQUE (item_id, location_id)
);

CREATE INDEX IF NOT EXISTS idx_m_stock_item_loc ON m_stock(item_id, location_id);

COMMIT;
